SELECT rating,
        MAX(length) AS min_length,
        MIN(length) AS max_length,
        AVG(length) AS avg_length,
        MAX(rental_rate) AS min_rental_rate,
        MIN(rental_rate) AS max_rental_rate,
        AVG(rental_rate) AS avg_rental_rate
FROM
(SELECT title,
       rental_rate,
	   length,
	   rating
FROM movie
WHERE rental_rate > 2
ORDER BY length DESC
LIMIT 40) AS m
GROUP BY rating
ORDER BY avg_length ASC

-- --

-- and FROM FROM FROM example

SELECT  AVG(mm.min_length) AS avg_min_length,
        AVG(mm.max_length) AS avg_max_length
FROM
    (SELECT top.rating,
           MIN(top.length) AS min_length,
           MAX(top.length) AS max_length,
           AVG(top.length) AS avg_length,
           MIN(top.rental_rate) AS min_rental_rate,
           MAX(top.rental_rate) AS max_rental_rate,
           AVG(top.rental_rate) AS avg_rental_rate
    FROM
      (SELECT title,
              rental_rate,
              length,
              rating
       FROM movie
       WHERE rental_rate > 2
       ORDER BY length DESC
       LIMIT 40) AS top
    GROUP BY top.rating
    ORDER BY avg_length) AS mm

-- --

SELECT billing_country
FROM
(
    SELECT  billing_country,
            sum(ii.avg_total) as ii_avg
    FROM
        (SELECT  billing_country,
                AVG(total) as avg_total,
                EXTRACT(month from CAST(invoice_date AS timestamp)) as month
        FROM invoice
        WHERE EXTRACT(year from CAST(invoice_date AS timestamp)) = 2009
        GROUP BY billing_country, EXTRACT(month from CAST(invoice_date AS timestamp))) as ii
    WHERE ((month = 10) or (month = 7) or (month = 5) or (month = 2))

    GROUP BY billing_country
    ) as iii
WHERE iii.ii_avg > 10


